name: external-sdk-watch

on:
  schedule:
    - cron: "17 1 * * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  watch:
    runs-on: ubuntu-latest
    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: Python 설정
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 외부 SDK 정책 변화 감시(strict)
        id: watch
        continue-on-error: true
        run: |
          python scripts/sdk_policy_watch.py \
            --watchlist docs/compliance/external_sdk_watchlist.json \
            --snapshot docs/compliance/external_sdk_snapshot.json \
            --report docs/compliance/external_sdk_watch_report.json \
            --strict

      - name: 감시 리포트 아티팩트 업로드
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: external-sdk-watch-report
          path: |
            docs/compliance/external_sdk_watch_report.json
            docs/compliance/external_sdk_snapshot.json

      - name: 변화 감지 이슈 생성
        if: steps.watch.outcome == 'failure'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require("fs");
            const reportPath = "docs/compliance/external_sdk_watch_report.json";
            const dateTag = new Date().toISOString().slice(0, 10);
            const titlePrefix = "[SDK Policy Drift]";
            const title = `${titlePrefix} ${dateTag}`;
            let body = "외부 SDK 정책 변화가 감지되었습니다. 첨부 아티팩트를 확인하세요.";

            if (fs.existsSync(reportPath)) {
              const report = JSON.parse(fs.readFileSync(reportPath, "utf8"));
              const changed = (report.changed_items || []).map((item) => `- ${item.id}: ${item.change_type}`).join("\n");
              const errors = (report.fetch_errors || []).map((item) => `- ${item.id}: ${item.error}`).join("\n");
              body = [
                "외부 SDK 정책 변화 감지 결과",
                "",
                `- 실행 시각: ${report.executed_at}`,
                `- 변경 건수: ${(report.changed_items || []).length}`,
                `- fetch 오류 건수: ${(report.fetch_errors || []).length}`,
                "",
                "## 변경 항목",
                changed || "- 없음",
                "",
                "## fetch 오류",
                errors || "- 없음",
                "",
                "조치: watchlist/snapshot 갱신 필요 여부를 점검하세요."
              ].join("\n");
            }

            const { owner, repo } = context.repo;
            const openIssues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: "open",
              per_page: 100
            });

            const alreadyExists = openIssues.data.some((issue) => issue.title.startsWith(titlePrefix));
            if (alreadyExists) {
              core.info("기존 SDK drift 이슈가 있어 신규 이슈 생성을 생략합니다.");
              return;
            }

            await github.rest.issues.create({
              owner,
              repo,
              title,
              body
            });

      - name: 정책 변화 차단(fail-closed)
        if: steps.watch.outcome == 'failure'
        run: |
          echo "External SDK policy drift detected"
          exit 1
